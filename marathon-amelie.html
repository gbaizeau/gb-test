<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Am√©lie's 12-Week Marathon Training Dashboard (4h00 Goal)</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üèÉ‚Äç‚ôÄÔ∏è</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script type="module">
        // Firebase SDKs are imported directly in the main script block
    </script>

    <!-- Chosen Palette: Slate & Teal -->
    <!-- Application Structure Plan: A dashboard layout is used to provide an at-a-glance overview. The left column contains key stats (countdown, paces) and a visual chart of weekly effort, providing constant context. The main right column dynamically displays the training plan, defaulting to "This Week's" workouts for immediate relevance. This structure was chosen to transform the static plan into an active, daily tool. Users can easily see what they need to do today, track their progress visually, and switch to the full plan for future planning, making the information highly consumable and user-friendly. -->
    <!-- Visualization & Content Choices: Weekly KM (Report Info) -> Goal: Visualize training load -> Viz: Bar Chart (Chart.js) -> Interaction: Hover for details -> Justification: Clearly shows workload progression and taper. | Training Schedule (Report Info) -> Goal: Present daily workouts clearly -> Viz: Interactive HTML Table -> Interaction: JS highlights current week, checkboxes mark completion/skipped/rescheduled, input fields for actuals, collapsible rows, undo actions -> Justification: Makes the plan an active tracking and logging tool, improving scannability and flexibility. | Race Date (Report Info) -> Goal: Build motivation -> Viz: Countdown Timer -> Interaction: None -> Justification: Creates a sense of urgency and excitement. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body { font-family: 'Inter', sans-serif; }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            height: 250px;
            max-height: 300px;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 300px;
                max-height: 350px;
            }
        }
        .table-cell-top { vertical-align: top; }
        
        .run-log-label { 
             transition: opacity 0.3s ease, text-decoration 0.3s ease;
        }
        .completed-run .run-log-label { 
            text-decoration: line-through;
            opacity: 0.7;
        }
         .skipped-run .run-log-label, .rescheduled-run .run-log-label {
            text-decoration: line-through;
            opacity: 0.5;
            color: #64748b; /* slate-500 */
        }

        .motivational-text {
            font-style: italic;
            color: #0d9488; /* teal-600 */
            padding-top: 4px;
            padding-bottom: 8px;
            font-size: 0.875rem;
        }
        .input-sm {
            font-size: 0.875rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            border: 1px solid #cbd5e1; /* slate-300 */
        }
        .input-error {
            border-color: #ef4444 !important; /* red-500 */
            box-shadow: 0 0 0 1px #ef4444;
        }
        .weekly-summary-row td {
            padding-top: 1rem !important; 
            padding-bottom: 1rem !important; 
            font-weight: 600;
        }
        .pace-greyed {
            color: #94a3b8; /* slate-400 */
        }
        .bg-custom-yellow { background-color: #fff3cc; } 
        .bg-teal-50 { background-color: #f0fdfa; } 
        .bg-slate-200-opacity { background-color: rgba(226, 232, 240, 0.7); } 
        .bg-blue-100-opacity { background-color: rgba(219, 234, 254, 0.7); } /* For rescheduled runs */


        .progress-bar-container {
            width: 100%;
            background-color: #e2e8f0; 
            border-radius: 0.5rem; 
            height: 1.5rem; 
            overflow: hidden;
            margin-bottom: 0.25rem;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);
        }
        .progress-bar {
            background-color: #10b981; 
            height: 100%;
            text-align: center;
            line-height: 1.5rem; 
            color: white;
            font-size: 0.875rem; 
            font-weight: bold;
            transition: width 0.5s ease-in-out;
            border-radius: 0.375rem 0 0 0.375rem; 
        }
        .progress-bar.full {
             border-radius: 0.375rem; 
        }
        .weekly-summary-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.95rem; 
            margin-bottom: 0.5rem;
        }
        .run-details-collapsible {
            display: none; 
            padding-left: 2.75rem; 
            margin-top: 0.75rem;
        }
        .run-details-collapsible.expanded {
            display: block;
        }
        .toggle-details-btn, .sidebar-toggle-btn, .tip-toggle-btn {
            cursor: pointer;
            margin-right: 0.5rem;
            font-weight: bold;
            color: #0d9488; 
            user-select: none;
            width: 1.5rem; 
            display: inline-block;
            text-align: center;
        }
        #auth-container {
            position: fixed;
            top: 1rem;
            right: 1rem;
            background-color: white;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            z-index: 50;
        }
        .read-only-log span {
            display: block;
            padding: 0.1rem 0;
        }
        .read-only-log strong {
            color: #475569; /* slate-600 */
        }
        .today-run-highlight {
            border-left: 4px solid #2dd4bf; /* teal-400 */
            background-color: #ccfbf1 !important; /* teal-100, more prominent */
        }
        .milestone-badge {
            background-color: #facc15; /* yellow-400 */
            color: #713f12; /* yellow-900 */
            padding: 0.1rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.7rem;
            font-weight: bold;
            margin-left: 0.5rem;
            vertical-align: middle;
        }
        .action-btn {
            color: white;
            padding: 0.1rem 0.4rem;
            font-size: 0.7rem;
            border-radius: 0.25rem;
            cursor: pointer;
            margin-left: 0.5rem;
        }
        .skip-btn { background-color: #f87171; /* red-400 */ }
        .skip-btn:hover { background-color: #ef4444; /* red-500 */ }
        .reschedule-btn { background-color: #60a5fa; /* blue-400 */ }
        .reschedule-btn:hover { background-color: #3b82f6; /* blue-500 */ }
        .undo-btn { background-color: #9ca3af; /* gray-400 */ }
        .undo-btn:hover { background-color: #6b7280; /* gray-500 */ }

        .sidebar-section-content, .tip-content { display: none; }
        .sidebar-section-content.expanded, .tip-content.expanded { display: block; }
        .tip-item { margin-left: 1.5rem; }
        .date-input-container {
            margin-top: 0.5rem;
            padding: 0.5rem;
            background-color: #f1f5f9; /* slate-100 */
            border-radius: 0.375rem;
            display: none; /* Hidden by default */
        }
        #reset-data-section { margin-top: 2rem; text-align: center; }
        #reset-data-btn {
            background-color: #dc2626; /* red-600 */
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        #reset-data-btn:hover { background-color: #b91c1c; /* red-700 */ }
        #reset-data-btn.hidden { display: none; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div id="auth-container">
        <button id="google-signin-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded text-sm transition-colors">
            Sign in with Google
        </button>
        <div id="user-info" class="hidden text-sm">
            <span id="user-name" class="font-semibold text-slate-700"></span>
            <button id="signout-btn" class="ml-3 bg-red-500 hover:bg-red-600 text-white font-semibold py-1 px-3 rounded text-xs transition-colors">
                Sign Out
            </button>
        </div>
    </div>

    <div class="container mx-auto p-4 md:p-8 mt-20"> 
        
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-slate-900">Am√©lie's Marathon Training Dashboard üìä</h1>
            <p class="text-lg text-slate-600 mt-1">Queenstown Marathon - 4h00 Goal</p>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">

            <aside class="lg:col-span-1 space-y-8">
                
                <section class="bg-white p-6 rounded-2xl shadow-sm">
                    <h2 class="text-xl font-bold text-slate-900 mb-3">Race Day Countdown ‚è≥</h2>
                    <p class="text-slate-600 mb-4">Queenstown Marathon: <strong class="text-teal-600">November 15th, 2025</strong></p>
                    <div id="countdown" class="flex justify-center space-x-2 sm:space-x-4 text-center bg-slate-100 p-4 rounded-lg">
                        <div><span id="days" class="text-2xl sm:text-4xl font-bold text-teal-600">--</span><p class="text-xs text-slate-500">Days</p></div>
                        <div><span id="hours" class="text-2xl sm:text-4xl font-bold text-teal-600">--</span><p class="text-xs text-slate-500">Hours</p></div>
                        <div><span id="minutes" class="text-2xl sm:text-4xl font-bold text-teal-600">--</span><p class="text-xs text-slate-500">Minutes</p></div>
                        <div><span id="seconds" class="text-2xl sm:text-4xl font-bold text-teal-600">--</span><p class="text-xs text-slate-500">Seconds</p></div>
                    </div>
                </section>

                <section class="bg-white p-6 rounded-2xl shadow-sm">
                    <div class="flex justify-between items-center mb-3">
                        <h2 class="text-xl font-bold text-slate-900">Weekly Volume üìà</h2>
                        <span class="sidebar-toggle-btn" data-target="weekly-volume-content">‚àí</span>
                    </div>
                    <div id="weekly-volume-content" class="sidebar-section-content expanded">
                        <p class="text-slate-600 mb-4">Track your planned vs. actual kilometers. Colors for past & current weeks: Green (‚â•95%), Orange (70-94%), Red (<70%).</p>
                        <div class="chart-container">
                            <canvas id="mileageChart"></canvas>
                        </div>
                    </div>
                </section>

                <section class="bg-white p-6 rounded-2xl shadow-sm">
                     <div class="flex justify-between items-center mb-3">
                        <h2 class="text-xl font-bold text-slate-900">Pace Guide üß≠</h2>
                        <span class="sidebar-toggle-btn" data-target="pace-guide-content">+</span>
                    </div>
                    <div id="pace-guide-content" class="sidebar-section-content">
                        <p class="text-slate-600 mb-4">Target paces for your 4-hour goal.</p>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between p-2 rounded bg-slate-50"><span>Easy Run (ER)</span><span class="font-semibold">6:15-7:00 /km</span></div>
                            <div class="flex justify-between p-2 rounded bg-slate-50"><span>Long Run (LR)</span><span class="font-semibold">6:10-6:30 /km</span></div>
                            <div class="flex justify-between p-2 rounded bg-slate-50"><span>Marathon Pace (MP)</span><span class="font-semibold text-teal-600">~5:41 /km</span></div>
                            <div class="flex justify-between p-2 rounded bg-slate-50"><span>Tempo Run (TR)</span><span class="font-semibold">5:15-5:25 /km</span></div>
                            <div class="flex justify-between p-2 rounded bg-slate-50"><span>Intervals (1k)</span><span class="font-semibold">5:00-5:10 /km</span></div>
                        </div>
                    </div>
                </section>

                 <section class="bg-white p-6 rounded-2xl shadow-sm">
                    <div class="flex justify-between items-center mb-3">
                        <h2 class="text-xl font-bold text-slate-900">Training & Race Tips üí°</h2>
                        <span class="sidebar-toggle-btn" data-target="tips-content-main">+</span>
                    </div>
                    <div id="tips-content-main" class="sidebar-section-content text-sm text-slate-600">
                        <div class="mb-3">
                            <div class="flex items-center cursor-pointer tip-category-header" data-target="tips-nutrition">
                                <span class="tip-toggle-btn">+</span><strong class="text-slate-700">Nutrition</strong>
                            </div>
                            <ul id="tips-nutrition" class="tip-content list-disc list-inside space-y-1 mt-1">
                                <li class="tip-item">Practice race day fueling on long runs. No new foods/gels on race day!</li>
                                <li class="tip-item">Aim for 30-60g of carbohydrates per hour during long efforts.</li>
                                <li class="tip-item">Experiment with different types of energy gels, chews, or real food to see what your stomach tolerates best.</li>
                                <li class="tip-item">Have a balanced pre-race meal 2-3 hours before the start, focusing on easily digestible carbs.</li>
                                <li class="tip-item">Start refueling with carbs and protein within 30-60 minutes after finishing long runs or hard workouts.</li>
                            </ul>
                        </div>
                        <div class="mb-3">
                             <div class="flex items-center cursor-pointer tip-category-header" data-target="tips-hydration">
                                <span class="tip-toggle-btn">+</span><strong class="text-slate-700">Hydration</strong>
                            </div>
                            <ul id="tips-hydration" class="tip-content list-disc list-inside space-y-1 mt-1">
                                <li class="tip-item">Drink water consistently throughout the day, every day, not just on run days.</li>
                                <li class="tip-item">Consider electrolytes (sodium, potassium) for runs longer than 60-90 minutes, especially in warm weather.</li>
                                <li class="tip-item">Practice drinking while running to get used to aid station cups or your hydration system.</li>
                                <li class="tip-item">Monitor urine color: pale yellow is a good sign of hydration. Dark yellow means drink more.</li>
                                <li class="tip-item">Don't overhydrate either; listen to your thirst.</li>
                            </ul>
                        </div>
                         <div class="mb-3">
                             <div class="flex items-center cursor-pointer tip-category-header" data-target="tips-recovery">
                                <span class="tip-toggle-btn">+</span><strong class="text-slate-700">Rest & Recovery</strong>
                            </div>
                            <ul id="tips-recovery" class="tip-content list-disc list-inside space-y-1 mt-1">
                                <li class="tip-item">Sleep is crucial for muscle repair and energy. Aim for 7-9 hours consistently.</li>
                                <li class="tip-item">Listen to your body; take extra rest days or easier days if feeling overly fatigued or experiencing pain.</li>
                                <li class="tip-item">Incorporate active recovery like light walking, stretching, or foam rolling.</li>
                                <li class="tip-item">Don't underestimate the power of a complete rest day. It's when your body adapts and gets stronger.</li>
                                <li class="tip-item">Manage stress, as high stress can impede recovery.</li>
                            </ul>
                        </div>
                         <div class="mb-3">
                             <div class="flex items-center cursor-pointer tip-category-header" data-target="tips-race-day">
                                <span class="tip-toggle-btn">+</span><strong class="text-slate-700">Race Day Specifics</strong>
                            </div>
                            <ul id="tips-race-day" class="tip-content list-disc list-inside space-y-1 mt-1">
                                <li class="tip-item">Pacing: Start your marathon slightly slower than your goal pace. Don't get carried away by the race day excitement!</li>
                                <li class="tip-item">Gear: Wear comfortable, tested shoes and clothing. Nothing new! Prepare for different weather conditions.</li>
                                <li class="tip-item">Mental Game: Visualize success. Break the race into smaller, manageable segments. Stay positive!</li>
                                <li class="tip-item">Arrive early to the start line to avoid stress, use restrooms, and do a light warm-up.</li>
                                <li class="tip-item">Know the course, especially aid station locations and any significant hills.</li>
                            </ul>
                        </div>
                    </div>
                </section>

            </aside>

            <div class="lg:col-span-2">
                <section class="bg-white p-6 rounded-2xl shadow-sm">
                    <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-4">
                        <h2 class="text-xl font-bold text-slate-900 mb-2 sm:mb-0">Training Schedule üóìÔ∏è</h2>
                        <div class="flex space-x-2">
                            <button id="view-week-btn" class="bg-teal-600 text-white py-2 px-4 rounded-lg font-semibold text-sm shadow-sm hover:bg-teal-700 transition-colors">This Week</button>
                            <button id="view-full-btn" class="bg-slate-200 text-slate-800 py-2 px-4 rounded-lg font-semibold text-sm hover:bg-slate-300 transition-colors">Full Plan</button>
                        </div>
                    </div>
                    <p id="plan-intro" class="text-slate-600 mb-6">Log your runs and track progress. Current week workouts are shown by default. Click '+' to expand details. Please sign in to save your progress.</p>
                    <div id="plan-container" class="overflow-x-auto">
                    </div>
                </section>
            </div>
        </main>
        <div id="reset-data-section">
            <button id="reset-data-btn" class="hidden">Reset All Training Data</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.7/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, deleteDoc } from "https://www.gstatic.com/firebasejs/9.6.7/firebase-firestore.js"; // Added deleteDoc
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.7/firebase-auth.js";

        const firebaseConfig = {
          apiKey: "AIzaSyBnA5aX_3AACrVZGWin-4keVfpojfF6XwY",
          authDomain: "ameliemarathonapp.firebaseapp.com",
          projectId: "ameliemarathonapp",
          storageBucket: "ameliemarathonapp.appspot.com",
          messagingSenderId: "393077695105",
          appId: "1:393077695105:web:43e68bf818da8699eda380"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        const planStartDate = new Date("2025-08-26T00:00:00"); 
        const raceDate = new Date("2025-11-15T08:00:00");
        const SHARED_RUN_LOG_DOC_ID = "amelieSharedPlanData_v1"; 
        
        const trainingPlanData = [
            { week: 1, dates: "Aug 26 - Sep 1", totalKm: 32, mon: "Rest", tue: "ER 8km + 4 Strides", wed: "Rest or XT", thu: "TR: 2km WU, 4km @ Tempo (5:15-5:25/km), 2km CD (8km total)", fri: "Rest", sat: "LR 16km", sun: "Rest or RR 3-5km", motivation: "Great start! Consistency is your superpower." },
            { week: 2, dates: "Sep 2 - Sep 8", totalKm: 39, mon: "Rest", tue: "ER 10km", wed: "Rest or XT", thu: "IT: 2km WU, 6x800m @ ~3:52-4:00 (400m jog recovery), 2km CD (approx 11km total)", fri: "Rest", sat: "LR 18km", sun: "Rest or RR 3-5km", motivation: "Building that base. Every km counts!" },
            { week: 3, dates: "Sep 9 - Sep 15", totalKm: 44, mon: "Rest", tue: "ER 10km + 4 Strides", wed: "Rest or XT", thu: "MP Run: 2km WU, 8km @ MP (5:41/km), 2km CD (12km total)", fri: "Rest", sat: "LR 22km", sun: "Rest or RR 3-5km", motivation: "First taste of Marathon Pace. You got this!" },
            { week: 4, dates: "Sep 16 - Sep 22", totalKm: 37, mon: "Rest", tue: "ER 8km", wed: "Rest or XT", thu: "TR: 2km WU, 5km @ Tempo (5:15-5:25/km), 2km CD (9km total)", fri: "Rest", sat: "LR 20km", sun: "Rest or RR 3-5km", motivation: "Solid week. Recover well, you're earning it." },
            { week: 5, dates: "Sep 23 - Sep 29", totalKm: 49, mon: "Rest", tue: "IT: 2km WU, 5x1km @ ~5:00-5:10/km (400m jog recovery), 2km CD (approx 11km total)", wed: "Rest or XT or RR 5km", thu: "ER 12km + 4 Strides", fri: "Rest", sat: "LR 26km", sun: "Rest", motivation: "Stepping up the intensity. Feel that strength!" },
            { week: 6, dates: "Sep 30 - Oct 6", totalKm: 54, mon: "Rest", tue: "ER 10km", wed: "Rest or XT", thu: "MP Run: 2km WU, 10km @ MP (5:41/km), 2km CD (14km total)", fri: "Rest", sat: "LR 30km", sun: "Rest or RR 5km", motivation: "30km! üéâ Huge milestone. Believe in your progress.", milestone: "Longest Run Prep" },
            { week: 7, dates: "Oct 7 - Oct 13", totalKm: 46, mon: "Rest", tue: "TR: 2km WU, 6km @ Tempo (5:15-5:25/km), 2km CD (10km total)", wed: "Rest or XT or RR 5km", thu: "ER 12km + 4 Strides", fri: "Rest", sat: "LR 24km (include 6-8km @ MP mid-run)", sun: "Rest", motivation: "Mixing it up. Stay focused and trust the process." },
            { week: 8, dates: "Oct 14 - Oct 20", totalKm: 54, mon: "Rest", tue: "IT: 7-8x800m @ ~3:52-4:00 (400m jog recovery), 2km CD (approx 11-12km total)", wed: "Rest or XT or RR 5km", thu: "ER 10km", fri: "Rest", sat: "LR 32km", sun: "Rest", motivation: "Longest run done! üí™ You're so ready for this.", milestone: "Peak Long Run" },
            { week: 9, dates: "Oct 21 - Oct 27", totalKm: 38, mon: "Rest", tue: "ER 8km", wed: "Rest or XT", thu: "MP Run: 2km WU, 6km @ MP (5:41/km), 2km CD (10km total)", fri: "Rest", sat: "LR 20km", sun: "Rest or RR 3-5km", motivation: "Taper time. Let your body absorb all that hard work." },
            { week: 10, dates: "Oct 28 - Nov 3", totalKm: 32, mon: "Rest", tue: "IT: 2km WU, 4x800m @ ~3:52-4:00 (400m jog recovery), 2km CD (approx 8km total)", wed: "Rest or XT or RR 3km", thu: "ER 8km + 4 Strides", fri: "Rest", sat: "LR 16km", sun: "Rest", motivation: "Stay sharp, stay rested. Nearly there!" },
            { week: 11, dates: "Nov 4 - Nov 10", totalKm: 21, mon: "Rest", tue: "ER 6km + 4 Strides", wed: "Rest or XT", thu: "ER 5km", fri: "Rest", sat: "LR 10km (very easy)", sun: "Rest", motivation: "Almost there. Visualize crossing that finish line!" },
            { week: 12, dates: "Nov 11 - Nov 15", totalKm: 12, mon: "Rest/3k shakeout", tue: "ER 4-5km + strides", wed: "Rest", thu: "ER 2-3km", fri: "Rest", sat: "RACE DAY! üèÅ", sun: "", motivation: "Race week! Enjoy every moment. You've earned this!", milestone: "Race Day!" }
        ];
        let mileageChartInstance = null;
        let expandedState = JSON.parse(localStorage.getItem('expandedState_Amelie_v1')) || {}; 
        let sidebarExpandedState = JSON.parse(localStorage.getItem('sidebarExpandedState_Amelie_v1')) || {
            'weekly-volume-content': true, 
            'pace-guide-content': false,
            'tips-content-main': false, 
            'tips-nutrition': false,     
            'tips-hydration': false,
            'tips-recovery': false,
            'tips-race-day': false
        };
        let runLogData = {}; 
        let currentUser = null;
        let unsubscribeFromFirestore = null; 

        const planContainer = document.getElementById('plan-container');
        const viewWeekBtn = document.getElementById('view-week-btn');
        const viewFullBtn = document.getElementById('view-full-btn');
        const planIntro = document.getElementById('plan-intro');
        const googleSigninBtn = document.getElementById('google-signin-btn');
        const signoutBtn = document.getElementById('signout-btn');
        const userInfoDiv = document.getElementById('user-info');
        const userNameSpan = document.getElementById('user-name');
        const resetDataBtn = document.getElementById('reset-data-btn');

        function saveExpandedState() {
            localStorage.setItem('expandedState_Amelie_v1', JSON.stringify(expandedState));
        }
        function saveSidebarExpandedState() {
            localStorage.setItem('sidebarExpandedState_Amelie_v1', JSON.stringify(sidebarExpandedState));
        }
        
        async function saveRunLogDataToFirestore() {
            if (!currentUser) { 
                console.warn("User not logged in. Cannot save data.");
            }
            try {
                const docRef = doc(db, "runLogs", SHARED_RUN_LOG_DOC_ID);
                await setDoc(docRef, runLogData, { merge: true });
            } catch (error) {
                console.error("Error saving run log data:", error);
                if (error.code === "permission-denied") {
                    alert("You do not have permission to save changes. Please ensure you are logged in with an authorized account.");
                }
            }
        }

        function loadRunLogDataFromFirestore() { 
            if (unsubscribeFromFirestore) {
                unsubscribeFromFirestore(); 
            }
            const docRef = doc(db, "runLogs", SHARED_RUN_LOG_DOC_ID);
            
            unsubscribeFromFirestore = onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    runLogData = docSnap.data();
                } else {
                    runLogData = {}; 
                    console.log("No shared run log data found, initializing empty set.");
                }
                renderPlan(viewFullBtn.classList.contains('bg-teal-600')); 
                renderChart();
            }, (error) => {
                console.error("Firebase Firestore Error (onSnapshot):", error.message);
                console.warn("This usually means Firestore security rules are not allowing read access to the 'runLogs/" + SHARED_RUN_LOG_DOC_ID + "' document for the current user (or public if not logged in). Please check your Firebase console's Firestore rules. For public read and specific user write, rules should be similar to: \n rules_version = '2';\n service cloud.firestore {\n   match /databases/{database}/documents {\n     match /runLogs/" + SHARED_RUN_LOG_DOC_ID + " {\n       allow read: if true;\n       allow write: if request.auth != null && (request.auth.uid == 'AMELIE_UID' || request.auth.uid == 'YOUR_UID');\n     }\n   }\n }");
                runLogData = {}; 
                renderPlan(viewFullBtn.classList.contains('bg-teal-600'));
                renderChart();
            });
        }

        function getWeekNumber(currentDate, pStartDate) {
            const msPerDay = 1000 * 60 * 60 * 24;
            const daysSinceStart = Math.floor((currentDate - pStartDate) / msPerDay);
            if (daysSinceStart < 0) return 1;
            const weekNum = Math.floor(daysSinceStart / 7) + 1;
            return weekNum > 12 ? 12 : weekNum;
        }

        const currentWeekNumberGlobal = getWeekNumber(new Date(), planStartDate);

        function getFormattedDate(baseDate, dayOffset) {
            const targetDate = new Date(baseDate);
            targetDate.setDate(targetDate.getDate() + dayOffset);
            return targetDate.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
        }
        
        function getISODateString(dateObj) {
            return dateObj.getFullYear() + '-' + String(dateObj.getMonth() + 1).padStart(2, '0') + '-' + String(dateObj.getDate()).padStart(2, '0');
        }


        function parseTimeToSeconds(timeStrInput) {
            if (!timeStrInput) return 0; 
            const timeStr = timeStrInput.trim();
            const hhmmssPattern = /^\d{1,2}:\d{2}:\d{2}$/;
            const mmssPattern = /^\d{1,2}:\d{2}$/;
            let parts;

            if (hhmmssPattern.test(timeStr)) {
                parts = timeStr.split(':').map(Number);
            } else if (mmssPattern.test(timeStr)) {
                parts = timeStr.split(':').map(Number);
                parts.unshift(0); 
            } else {
                return -1; 
            }
            if (parts.length === 3 && parts.every(p => !isNaN(p)) && parts[0] >= 0 && parts[1] >= 0 && parts[1] < 60 && parts[2] >= 0 && parts[2] < 60) {
                return parts[0] * 3600 + parts[1] * 60 + parts[2];
            }
            return -1;
        }
        
        function isValidDistance(distStr) {
            if (!distStr && distStr !== "0") return true; 
            const num = parseFloat(distStr);
            return !isNaN(num) && num >= 0;
        }


        function formatSecondsToHHMMSS(totalSeconds) {
            if (isNaN(totalSeconds) || totalSeconds <= 0) return "00:00:00";
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = Math.floor(totalSeconds % 60);
            return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        function calculatePace(timeStr, distanceKm) {
            const totalSeconds = parseTimeToSeconds(timeStr);
            const distance = parseFloat(distanceKm);
            if (totalSeconds > 0 && distance > 0) {
                const paceSecondsPerKm = totalSeconds / distance;
                const paceMinutes = Math.floor(paceSecondsPerKm / 60);
                const paceSeconds = Math.floor(paceSecondsPerKm % 60);
                return `${String(paceMinutes).padStart(2, '0')}:${String(paceSeconds).padStart(2, '0')} /km`;
            }
            return "--:-- /km";
        }

        function findNextUpcomingRunId() {
            const today = new Date();
            today.setHours(0,0,0,0);

            for (const weekData of trainingPlanData) {
                const weekStartDate = new Date(planStartDate);
                weekStartDate.setDate(weekStartDate.getDate() + (weekData.week - 1) * 7);
                const daysOfWeek = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
                const plannedWorkouts = [weekData.mon, weekData.tue, weekData.wed, weekData.thu, weekData.fri, weekData.sat, weekData.sun];

                for (let dayIndex = 0; dayIndex < daysOfWeek.length; dayIndex++) {
                    const plannedWorkout = plannedWorkouts[dayIndex];
                    if (plannedWorkout) {
                        const runDate = new Date(weekStartDate);
                        runDate.setDate(runDate.getDate() + dayIndex);
                        runDate.setHours(0,0,0,0);
                        const runId = `w${weekData.week}d${dayIndex}`;
                        const log = runLogData[runId] || { completed: false, status: 'pending' };
                        const isRestDay = plannedWorkout.toLowerCase().startsWith("rest");

                        if (runDate >= today && !isRestDay && log.status !== 'completed' && log.status !== 'skipped') {
                            return runId;
                        }
                    }
                }
            }
            return null; 
        }
        
        function createTable(dataToDisplay, isFullView, currentDisplayWeek) {
            const table = document.createElement('table');
            table.className = 'w-full text-sm text-left border-collapse';
            
            const thead = document.createElement('thead');
            let headerRowHTML = `<tr class="border-b border-slate-300 bg-slate-100">`;
            if (isFullView) {
                headerRowHTML += `<th class="p-3 font-semibold text-slate-700">Wk</th>`;
            }
            headerRowHTML += `<th class="p-3 font-semibold text-slate-700">Day & Date</th>
                              <th class="p-3 font-semibold text-slate-700">
                                  <div class="flex justify-between items-center">
                                      <span>Workout & Log</span>
                                      <div class="flex space-x-1">
                                          <button id="expand-all-btn-table" class="bg-sky-500 text-white py-0.5 px-2 rounded text-xs hover:bg-sky-600 transition-colors">Expand All</button>
                                          <button id="collapse-all-btn-table" class="bg-sky-500 text-white py-0.5 px-2 rounded text-xs hover:bg-sky-600 transition-colors">Collapse All</button>
                                      </div>
                                  </div>
                              </th></tr>`;
            thead.innerHTML = headerRowHTML;
            table.appendChild(thead);

            const tbody = document.createElement('tbody');
            const nextUpcomingRunId = findNextUpcomingRunId();
            const todayFormatted = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric'});


            dataToDisplay.forEach(weekData => {
                if (isFullView) {
                    const summaryRowTop = document.createElement('tr');
                    let summaryBgClassTop = (weekData.week === currentDisplayWeek) ? 'bg-teal-50' : 'bg-slate-100';
                    summaryRowTop.className = `border-t-2 border-b border-slate-300 ${summaryBgClassTop}`;
                    let smHTMLTop = `<td class="p-3"></td>`; 
                    smHTMLTop += `<td colspan="2" class="p-3 weekly-summary-row">
                                    <div id="week-${weekData.week}-summary-visuals" class="mb-2"></div>
                                    ${weekData.motivation ? `<div class="motivational-text text-center">${weekData.motivation}</div>` : ''}
                                </td>`;
                    summaryRowTop.innerHTML = smHTMLTop;
                    tbody.appendChild(summaryRowTop);
                }


                const weekStartDate = new Date(planStartDate);
                weekStartDate.setDate(weekStartDate.getDate() + (weekData.week - 1) * 7);

                const daysOfWeek = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
                const plannedWorkouts = [weekData.mon, weekData.tue, weekData.wed, weekData.thu, weekData.fri, weekData.sat, weekData.sun];
                
                let dayCounterForWeek = 0;
                plannedWorkouts.forEach(workout => { if(workout) dayCounterForWeek++; });

                daysOfWeek.forEach((dayName, dayIndex) => {
                    const plannedWorkout = plannedWorkouts[dayIndex];
                    if (plannedWorkout) {
                        const runId = `w${weekData.week}d${dayIndex}`;
                        const log = runLogData[runId] || { status: 'pending', actualTime: '', actualDistance: '', comments: '', calculatedPace: '--:-- /km', rescheduledTo: null, previousStatus: 'pending' };
                        const isCurrentActualWeek = weekData.week === currentDisplayWeek;
                        const exactDateStr = getFormattedDate(weekStartDate, dayIndex);
                        const isRestDay = plannedWorkout.toLowerCase().startsWith("rest");
                        const isToday = exactDateStr === todayFormatted;
                        
                        const row = document.createElement('tr');
                        let rowBgClass = '';
                        if (!isRestDay) {
                            if (log.status === 'completed') rowBgClass = 'bg-teal-50';
                            else if (log.status === 'skipped') rowBgClass = 'bg-slate-200-opacity';
                            else if (log.status === 'rescheduled') rowBgClass = 'bg-blue-100-opacity';
                            else rowBgClass = 'bg-custom-yellow';
                        } else if (isCurrentActualWeek) {
                            rowBgClass = 'bg-teal-50'; 
                        }
                        
                        row.className = `border-b border-slate-200 ${rowBgClass} ${isToday && !isRestDay ? 'today-run-highlight' : ''}`;
                        if ((log.status === 'completed' || log.status === 'skipped' || log.status === 'rescheduled') && !isRestDay) {
                            row.classList.add(log.status === 'completed' ? 'completed-run' : (log.status === 'skipped' ? 'skipped-run' : 'rescheduled-run') );
                        }
                        
                        let rowHTML = '';
                        if (isFullView) {
                            const firstDayWithWorkoutIndex = plannedWorkouts.findIndex(w => w);
                            if (dayIndex === firstDayWithWorkoutIndex) {
                                 rowHTML += `<td rowspan="${dayCounterForWeek}" class="p-3 font-semibold table-cell-top text-center border-r border-slate-200">${weekData.week}</td>`;
                            }
                        }
                        rowHTML += `<td class="p-3 font-semibold text-slate-600 table-cell-top ${isToday ? 'font-bold text-teal-700':''}">${exactDateStr} ${isToday ? ' (Today)' : ''}</td>`;
                        
                        if (isRestDay) {
                            rowHTML += `<td class="p-3">
                                <span class="font-medium text-slate-800">${plannedWorkout}</span>
                            </td>`;
                        } else {
                            const isExpanded = expandedState[runId] === undefined ? (runId === nextUpcomingRunId && log.status !== 'completed' && log.status !== 'skipped' && log.status !== 'rescheduled') : expandedState[runId];
                            if (expandedState[runId] === undefined && runId === nextUpcomingRunId && log.status !== 'completed' && log.status !== 'skipped' && log.status !== 'rescheduled') expandedState[runId] = true;

                            let milestoneBadge = '';
                            if (log.status === 'completed' && trainingPlanData[weekData.week-1].milestone && (plannedWorkout.includes("LR 30km") || plannedWorkout.includes("LR 32km") || plannedWorkout.includes("RACE DAY"))) {
                                milestoneBadge = `<span class="milestone-badge">üéâ Milestone!</span>`;
                            }
                            
                            let rescheduledText = '';
                            if (log.status === 'rescheduled' && log.rescheduledTo) {
                                rescheduledText = `<span class="text-xs text-blue-600 ml-2">(Rescheduled to ${new Date(log.rescheduledTo + 'T00:00:00').toLocaleDateString('en-US', {month: 'short', day: 'numeric'}) })</span>`;
                            }

                            if (currentUser) { 
                                rowHTML += `<td class="p-3">
                                    <div class="flex items-center gap-1 flex-wrap">
                                        <span class="toggle-details-btn" data-runid="${runId}">${isExpanded ? '‚àí' : '+'}</span>
                                        <input type="checkbox" id="${runId}-completed" data-runid="${runId}" class="run-checkbox-completed h-5 w-5 mt-1 rounded border-gray-400 text-teal-600 focus:ring-teal-500 cursor-pointer" 
                                            ${log.status === 'completed' ? 'checked' : ''} 
                                            ${log.status === 'skipped' || log.status === 'rescheduled' ? 'disabled' : ''}>
                                        <label for="${runId}-completed" class="run-log-label flex-1 font-medium text-slate-800 cursor-pointer">${plannedWorkout}</label>
                                        ${milestoneBadge}
                                        <div class="ml-auto flex items-center space-x-1 mt-1 sm:mt-0">
                                            ${log.status === 'skipped' || log.status === 'rescheduled' ? `<button class="undo-btn action-btn" data-runid="${runId}" data-previous-status="${log.previousStatus || 'pending'}">Undo</button>` : ''}
                                            ${log.status !== 'skipped' && log.status !== 'rescheduled' ? `<button class="skip-btn action-btn" data-runid="${runId}">Skip</button>` : ''}
                                            ${log.status !== 'skipped' ? `<button class="reschedule-btn action-btn" data-runid="${runId}">Reschedule</button>` : ''}
                                        </div>
                                        ${log.status === 'skipped' ? '<span class="text-xs text-slate-500 w-full pl-7">(Skipped)</span>' : ''}
                                        ${rescheduledText ? `<span class="text-xs text-blue-600 w-full pl-7">${rescheduledText.replace(/<\/?span[^>]*>/g,'')}</span>` : ''}
                                    </div>
                                    <div id="${runId}-details" class="run-details-collapsible ${isExpanded ? 'expanded' : ''}">
                                        <div id="${runId}-reschedule-input-container" class="date-input-container">
                                             <label for="${runId}-reschedule-date" class="block text-xs font-medium text-slate-500 mb-1">New Date:</label>
                                             <input type="date" id="${runId}-reschedule-date" class="input-sm mr-2">
                                             <button class="confirm-reschedule-btn action-btn bg-green-500 hover:bg-green-600" data-runid="${runId}">Confirm</button>
                                             <button class="cancel-reschedule-btn action-btn bg-gray-400 hover:bg-gray-500" data-runid="${runId}">Cancel</button>
                                        </div>
                                        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3 mt-2">
                                            <div>
                                                <label for="${runId}-time" class="block text-xs font-medium text-slate-500 mb-1">Time Ran</label>
                                                <input type="text" id="${runId}-time" data-runid="${runId}" value="${log.actualTime || ''}" placeholder="HH:MM:SS or MM:SS" class="actual-time-input input-sm w-full" ${log.status === 'skipped' ? 'disabled' : ''}>
                                            </div>
                                            <div>
                                                <label for="${runId}-dist" class="block text-xs font-medium text-slate-500 mb-1">Distance (km)</label>
                                                <input type="number" id="${runId}-dist" data-runid="${runId}" value="${log.actualDistance || ''}" step="0.01" placeholder="e.g., 5.25" class="actual-distance-input input-sm w-full" ${log.status === 'skipped' ? 'disabled' : ''}>
                                            </div>
                                            <div>
                                                <label class="block text-xs font-medium text-slate-500 mb-1">Actual Pace</label>
                                                <span id="${runId}-pace" class="calculated-pace block p-1.5 text-sm ${log.calculatedPace === '--:-- /km' || !log.calculatedPace ? 'pace-greyed' : 'font-semibold text-slate-700'}">${log.calculatedPace || '--:-- /km'}</span>
                                            </div>
                                        </div>
                                        <div class="mt-2">
                                            <label for="${runId}-comments" class="block text-xs font-medium text-slate-500 mb-1">Comments</label>
                                            <textarea id="${runId}-comments" data-runid="${runId}" placeholder="How was the run? Any notes..." class="actual-comments-input input-sm w-full text-xs" rows="2" ${log.status === 'skipped' ? 'disabled' : ''}>${log.comments || ''}</textarea>
                                        </div>
                                    </div>
                                </td>`;
                            } else { 
                                 rowHTML += `<td class="p-3">
                                    <div class="flex items-start gap-1">
                                        <span class="toggle-details-btn" data-runid="${runId}">${isExpanded ? '‚àí' : '+'}</span>
                                        <span class="h-5 w-5 mt-1 mr-1 text-slate-500 font-semibold">${log.status === 'completed' ? '‚úì' : (log.status === 'skipped' ? '‚äò' :(log.status === 'rescheduled' ? '‚Ü™' : '‚óã'))}</span>
                                        <label class="run-log-label flex-1 font-medium text-slate-800">${plannedWorkout}</label>
                                        ${milestoneBadge}
                                        ${log.status === 'skipped' ? '<span class="text-xs text-slate-500 ml-2">(Skipped)</span>' : ''}
                                        ${rescheduledText}
                                    </div>
                                     <div id="${runId}-details" class="run-details-collapsible read-only-log ${isExpanded ? 'expanded' : ''}">
                                        ${log.actualTime ? `<span><strong>Time:</strong> ${log.actualTime}</span>` : ''}
                                        ${log.actualDistance ? `<span><strong>Distance:</strong> ${log.actualDistance} km</span>` : ''}
                                        ${log.calculatedPace && log.calculatedPace !== '--:-- /km' ? `<span><strong>Pace:</strong> ${log.calculatedPace}</span>` : ''}
                                        ${log.comments ? `<div class="mt-1"><strong>Comments:</strong><div class="italic text-slate-500 whitespace-pre-wrap">${log.comments}</div></div>` : ''}
                                        ${!(log.actualTime || log.actualDistance || log.comments) && log.status !== 'skipped' && log.status !== 'rescheduled' ? '<span class="text-slate-400 text-xs">No details logged for this run.</span>' : ''}
                                    </div>
                                </td>`;
                            }
                        }
                        
                        row.innerHTML = rowHTML;
                        tbody.appendChild(row);
                    }
                });
                
                if (!isFullView && (weekData.motivation || true)) { 
                     const summaryRowBottom = document.createElement('tr');
                     let summaryBgClassBottom = (weekData.week === currentDisplayWeek) ? 'bg-teal-50' : 'bg-slate-100';
                     summaryRowBottom.className = `border-t-2 border-b-2 border-slate-300 ${summaryBgClassBottom}`;
                     let smHTMLBottom = `<td colspan="3" class="p-3 weekly-summary-row">
                                        <div id="week-${weekData.week}-summary-visuals" class="mb-2"></div>
                                        ${weekData.motivation ? `<div class="motivational-text text-center">${weekData.motivation}</div>` : ''}
                                    </td>`;
                     summaryRowBottom.innerHTML = smHTMLBottom;
                     tbody.appendChild(summaryRowBottom);
                }
                 updateWeeklySummaryDisplay(weekData.week, weekData.totalKm); 
            });
            table.appendChild(tbody);

            const expandAllTableBtn = table.querySelector('#expand-all-btn-table');
            const collapseAllTableBtn = table.querySelector('#collapse-all-btn-table');
            if(expandAllTableBtn) expandAllTableBtn.addEventListener('click', () => toggleAllDetails(true));
            if(collapseAllTableBtn) collapseAllTableBtn.addEventListener('click', () => toggleAllDetails(false));

            return table;
        }
        
        async function updateRunDataAndUI(runId, field, value) {
            const currentLog = runLogData[runId] || { status: 'pending', actualTime: '', actualDistance: '', comments: '', calculatedPace: '--:-- /km', rescheduledTo: null, previousStatus: 'pending' };
            
            if ((field === 'status' && (value === 'skipped' || value === 'rescheduled')) || (field === 'undo')) {
                if (currentLog.status !== 'skipped' && currentLog.status !== 'rescheduled') { 
                    currentLog.previousStatus = currentLog.status;
                }
            }
            
            if (!runLogData[runId]) {
                runLogData[runId] = { ...currentLog }; 
            }

            if (field === 'actualTime') {
                value = typeof value === 'string' ? value.trim() : value;
            }
            
            if (field === 'undo') {
                runLogData[runId].status = currentLog.previousStatus || 'pending';
                runLogData[runId].rescheduledTo = null; 
                if (runLogData[runId].status !== 'completed') { // Only clear if not reverting to completed
                    runLogData[runId].actualTime = '';
                    runLogData[runId].actualDistance = '';
                    // runLogData[runId].comments = ''; // Keep comments on undo for now
                    runLogData[runId].calculatedPace = '--:-- /km';
                }
            } else if (field === 'status') { 
                runLogData[runId].status = value;
                if (value === 'skipped') {
                    runLogData[runId].completed = false; 
                    runLogData[runId].actualTime = ''; runLogData[runId].actualDistance = ''; runLogData[runId].comments = ''; runLogData[runId].calculatedPace = '--:-- /km';
                    runLogData[runId].rescheduledTo = null;
                } else if (value === 'rescheduled') {
                     runLogData[runId].completed = false;
                     // Keep logged data for rescheduled runs unless explicitly cleared by undo
                }
            } else if (field === 'completed') {
                 runLogData[runId].status = value ? 'completed' : 'pending';
                 runLogData[runId].completed = value; 
                 if (value) runLogData[runId].rescheduledTo = null; 
            } else if (field === 'rescheduledTo') {
                 runLogData[runId].rescheduledTo = value;
                 if (value) { 
                     runLogData[runId].status = 'rescheduled';
                     runLogData[runId].completed = false;
                 } else { 
                    runLogData[runId].status = currentLog.previousStatus || 'pending';
                 }
            }
            else {
                runLogData[runId][field] = value;
            }


            const rowElement = document.getElementById(`${runId}-completed`)?.closest('tr');
            const timeInputEl = document.getElementById(`${runId}-time`);
            const distInputEl = document.getElementById(`${runId}-dist`);
            const completedCheckbox = document.getElementById(`${runId}-completed`);
            const commentsInputEl = document.getElementById(`${runId}-comments`);
            const skipBtnEl = planContainer.querySelector(`.skip-btn[data-runid="${runId}"]`);
            const rescheduleBtnEl = planContainer.querySelector(`.reschedule-btn[data-runid="${runId}"]`);
            // Undo button will be managed by re-rendering the row


            if (field === 'actualTime' || field === 'actualDistance') {
                if(timeInputEl) timeInputEl.classList.toggle('input-error', parseTimeToSeconds(runLogData[runId].actualTime) === -1 && runLogData[runId].actualTime !== '');
                if(distInputEl) distInputEl.classList.toggle('input-error', !isValidDistance(runLogData[runId].actualDistance) && runLogData[runId].actualDistance !== '');
                
                const newPace = calculatePace(runLogData[runId].actualTime, runLogData[runId].actualDistance);
                runLogData[runId].calculatedPace = newPace;
                const paceEl = document.getElementById(`${runId}-pace`);
                if (paceEl) {
                    paceEl.textContent = newPace;
                    paceEl.classList.toggle('pace-greyed', newPace === '--:-- /km');
                    paceEl.classList.toggle('font-semibold', newPace !== '--:-- /km');
                    paceEl.classList.toggle('text-slate-700', newPace !== '--:-- /km');
                }

                const timeVal = runLogData[runId].actualTime;
                const distVal = runLogData[runId].actualDistance;
                const timeIsEnteredAndValid = timeVal && parseTimeToSeconds(timeVal) !== -1;
                const distIsEnteredAndValid = distVal && isValidDistance(distVal) && parseFloat(distVal) > 0;

                if (timeIsEnteredAndValid && distIsEnteredAndValid && runLogData[runId].status === 'pending') {
                    runLogData[runId].status = 'completed'; 
                    runLogData[runId].completed = true;
                    if (completedCheckbox) completedCheckbox.checked = true; 
                }
            }
            
            // Re-render the specific row for UI consistency after state change
            if (rowElement) {
                const isFullView = viewFullBtn.classList.contains('bg-teal-600');
                const weekNumberFromRunId = parseInt(runId.match(/w(\d+)/)[1]);
                const weekData = trainingPlanData.find(w => w.week === weekNumberFromRunId);
                const dayIndex = parseInt(runId.match(/d(\d+)/)[1]);
                
                const tempContainer = document.createElement('div'); // Create a temporary container
                const newRow = createSingleRow(weekData, dayIndex, isFullView, currentWeekNumberGlobal, findNextUpcomingRunId(), new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric'}));
                tempContainer.appendChild(newRow);
                rowElement.outerHTML = tempContainer.innerHTML; // Replace the old row with the new one
            }


            await saveRunLogDataToFirestore(); 
            const weekNumber = parseInt(runId.match(/w(\d+)/)[1]);
            const weekPlan = trainingPlanData.find(w => w.week === weekNumber);
            if(weekPlan) {
                updateWeeklySummaryDisplay(weekNumber, weekPlan.totalKm);
                renderChart(); 
            }
        }

         // Helper function to create a single row, to be called by createTable and updateRunDataAndUI
        function createSingleRow(weekData, dayIndex, isFullView, currentDisplayWeek, nextUpcomingRunId, todayFormatted) {
            const weekStartDate = new Date(planStartDate);
            weekStartDate.setDate(weekStartDate.getDate() + (weekData.week - 1) * 7);
            const plannedWorkout = [weekData.mon, weekData.tue, weekData.wed, weekData.thu, weekData.fri, weekData.sat, weekData.sun][dayIndex];
            const runId = `w${weekData.week}d${dayIndex}`;
            const log = runLogData[runId] || { status: 'pending', actualTime: '', actualDistance: '', comments: '', calculatedPace: '--:-- /km', rescheduledTo: null, previousStatus: 'pending' };
            const isCurrentActualWeek = weekData.week === currentDisplayWeek;
            const exactDateStr = getFormattedDate(weekStartDate, dayIndex);
            const isRestDay = plannedWorkout.toLowerCase().startsWith("rest");
            const isToday = exactDateStr === todayFormatted;

            const row = document.createElement('tr');
            let rowBgClass = '';
            if (!isRestDay) {
                if (log.status === 'completed') rowBgClass = 'bg-teal-50';
                else if (log.status === 'skipped') rowBgClass = 'bg-slate-200-opacity';
                else if (log.status === 'rescheduled') rowBgClass = 'bg-blue-100-opacity';
                else rowBgClass = 'bg-custom-yellow';
            } else if (isCurrentActualWeek) {
                rowBgClass = 'bg-teal-50';
            }

            row.className = `border-b border-slate-200 ${rowBgClass} ${isToday && !isRestDay ? 'today-run-highlight' : ''}`;
            if ((log.status === 'completed' || log.status === 'skipped' || log.status === 'rescheduled') && !isRestDay) {
                row.classList.add(log.status === 'completed' ? 'completed-run' : (log.status === 'skipped' ? 'skipped-run' : 'rescheduled-run'));
            }

            let rowHTML = '';
            // Note: Week column (rowspan) logic is handled in the main createTable loop for simplicity
            // This helper focuses on the Day and Workout/Log cells for a single row
            if (isFullView && dayIndex === plannedWorkouts.findIndex(w => w)) { // Placeholder for wk column if it's the first rendered day of the week
                 // This part is tricky to do perfectly in a helper for a single row with rowspan.
                 // The main createTable loop should handle the `<td>` for the week number.
            }

            rowHTML += `<td class="p-3 font-semibold text-slate-600 table-cell-top ${isToday ? 'font-bold text-teal-700':''}">${exactDateStr} ${isToday ? ' (Today)' : ''}</td>`;

            if (isRestDay) {
                rowHTML += `<td class="p-3">
                    <span class="font-medium text-slate-800">${plannedWorkout}</span>
                </td>`;
            } else {
                const isExpanded = expandedState[runId] === undefined ? (runId === nextUpcomingRunId && log.status !== 'completed' && log.status !== 'skipped' && log.status !== 'rescheduled') : expandedState[runId];
                let milestoneBadge = '';
                 if (log.status === 'completed' && weekData.milestone && (plannedWorkout.includes("LR 30km") || plannedWorkout.includes("LR 32km") || plannedWorkout.includes("RACE DAY"))) {
                    milestoneBadge = `<span class="milestone-badge">üéâ Milestone!</span>`;
                }
                let rescheduledText = '';
                if (log.status === 'rescheduled' && log.rescheduledTo) {
                    rescheduledText = `<span class="text-xs text-blue-600 ml-2">(Rescheduled to ${new Date(log.rescheduledTo + 'T00:00:00').toLocaleDateString('en-US', {month: 'short', day: 'numeric'}) })</span>`;
                }

                 if (currentUser) { 
                    rowHTML += `<td class="p-3">
                        <div class="flex items-center gap-1 flex-wrap">
                            <span class="toggle-details-btn" data-runid="${runId}">${isExpanded ? '‚àí' : '+'}</span>
                            <input type="checkbox" id="${runId}-completed" data-runid="${runId}" class="run-checkbox-completed h-5 w-5 mt-1 rounded border-gray-400 text-teal-600 focus:ring-teal-500 cursor-pointer" 
                                ${log.status === 'completed' ? 'checked' : ''} 
                                ${log.status === 'skipped' || log.status === 'rescheduled' ? 'disabled' : ''}>
                            <label for="${runId}-completed" class="run-log-label flex-1 font-medium text-slate-800 cursor-pointer">${plannedWorkout}</label>
                            ${milestoneBadge}
                            <div class="ml-auto flex items-center space-x-1 mt-1 sm:mt-0">
                                ${log.status === 'skipped' || log.status === 'rescheduled' ? `<button class="undo-btn action-btn" data-runid="${runId}" data-previous-status="${log.previousStatus || 'pending'}">Undo</button>` : ''}
                                ${log.status !== 'skipped' && log.status !== 'rescheduled' ? `<button class="skip-btn action-btn" data-runid="${runId}">Skip</button>` : ''}
                                ${log.status !== 'skipped' ? `<button class="reschedule-btn action-btn" data-runid="${runId}">Reschedule</button>` : ''}
                            </div>
                            ${log.status === 'skipped' ? '<span class="text-xs text-slate-500 w-full pl-7">(Skipped)</span>' : ''}
                            ${rescheduledText ? `<span class="text-xs text-blue-600 w-full pl-7">${rescheduledText.replace(/<\/?span[^>]*>/g,'')}</span>` : ''}
                        </div>
                        <div id="${runId}-details" class="run-details-collapsible ${isExpanded ? 'expanded' : ''}">
                            <div id="${runId}-reschedule-input-container" class="date-input-container">
                                 <label for="${runId}-reschedule-date" class="block text-xs font-medium text-slate-500 mb-1">New Date:</label>
                                 <input type="date" id="${runId}-reschedule-date" class="input-sm mr-2">
                                 <button class="confirm-reschedule-btn action-btn bg-green-500 hover:bg-green-600" data-runid="${runId}">Confirm</button>
                                 <button class="cancel-reschedule-btn action-btn bg-gray-400 hover:bg-gray-500" data-runid="${runId}">Cancel</button>
                            </div>
                            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3 mt-2">
                                <div>
                                    <label for="${runId}-time" class="block text-xs font-medium text-slate-500 mb-1">Time Ran</label>
                                    <input type="text" id="${runId}-time" data-runid="${runId}" value="${log.actualTime || ''}" placeholder="HH:MM:SS or MM:SS" class="actual-time-input input-sm w-full" ${log.status === 'skipped' ? 'disabled' : ''}>
                                </div>
                                <div>
                                    <label for="${runId}-dist" class="block text-xs font-medium text-slate-500 mb-1">Distance (km)</label>
                                    <input type="number" id="${runId}-dist" data-runid="${runId}" value="${log.actualDistance || ''}" step="0.01" placeholder="e.g., 5.25" class="actual-distance-input input-sm w-full" ${log.status === 'skipped' ? 'disabled' : ''}>
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-slate-500 mb-1">Actual Pace</label>
                                    <span id="${runId}-pace" class="calculated-pace block p-1.5 text-sm ${log.calculatedPace === '--:-- /km' || !log.calculatedPace ? 'pace-greyed' : 'font-semibold text-slate-700'}">${log.calculatedPace || '--:-- /km'}</span>
                                </div>
                            </div>
                            <div class="mt-2">
                                <label for="${runId}-comments" class="block text-xs font-medium text-slate-500 mb-1">Comments</label>
                                <textarea id="${runId}-comments" data-runid="${runId}" placeholder="How was the run? Any notes..." class="actual-comments-input input-sm w-full text-xs" rows="2" ${log.status === 'skipped' ? 'disabled' : ''}>${log.comments || ''}</textarea>
                            </div>
                        </div>
                    </td>`;
                } else { 
                     rowHTML += `<td class="p-3">
                        <div class="flex items-start gap-1">
                            <span class="toggle-details-btn" data-runid="${runId}">${isExpanded ? '‚àí' : '+'}</span>
                            <span class="h-5 w-5 mt-1 mr-1 text-slate-500 font-semibold">${log.status === 'completed' ? '‚úì' : (log.status === 'skipped' ? '‚äò' :(log.status === 'rescheduled' ? '‚Ü™' : '‚óã'))}</span>
                            <label class="run-log-label flex-1 font-medium text-slate-800">${plannedWorkout}</label>
                            ${milestoneBadge}
                            ${log.status === 'skipped' ? '<span class="text-xs text-slate-500 ml-2">(Skipped)</span>' : ''}
                            ${rescheduledText}
                        </div>
                         <div id="${runId}-details" class="run-details-collapsible read-only-log ${isExpanded ? 'expanded' : ''}">
                            ${log.actualTime ? `<span><strong>Time:</strong> ${log.actualTime}</span>` : ''}
                            ${log.actualDistance ? `<span><strong>Distance:</strong> ${log.actualDistance} km</span>` : ''}
                            ${log.calculatedPace && log.calculatedPace !== '--:-- /km' ? `<span><strong>Pace:</strong> ${log.calculatedPace}</span>` : ''}
                            ${log.comments ? `<div class="mt-1"><strong>Comments:</strong><div class="italic text-slate-500 whitespace-pre-wrap">${log.comments}</div></div>` : ''}
                            ${!(log.actualTime || log.actualDistance || log.comments) && log.status !== 'skipped' && log.status !== 'rescheduled' ? '<span class="text-slate-400 text-xs">No details logged for this run.</span>' : ''}
                        </div>
                    </td>`;
                }
            }
            row.innerHTML = rowHTML;
            return row;
        }


        function attachInputListeners() {
            planContainer.addEventListener('change', function(e) {
                if (e.target.classList.contains('run-checkbox-completed')) {
                    if (!currentUser) { 
                        e.target.checked = !e.target.checked; 
                        alert("Please sign in to log your runs.");
                        return;
                    }
                    const runId = e.target.dataset.runid;
                    updateRunDataAndUI(runId, 'completed', e.target.checked);
                }
            });
            planContainer.addEventListener('blur', function(e) {
                const target = e.target;
                 if (!currentUser) return; 

                let field = null;
                let processedValue = target.value; 
                if (target.classList.contains('actual-time-input')) {
                    field = 'actualTime';
                    processedValue = target.value.trim(); 
                } else if (target.classList.contains('actual-distance-input')) {
                    field = 'actualDistance';
                } else if (target.classList.contains('actual-comments-input')) {
                    field = 'comments';
                }
                
                if (field) {
                    const runId = target.dataset.runid;
                    updateRunDataAndUI(runId, field, processedValue);
                }
            }, true); 

            planContainer.addEventListener('click', function(e) {
                if (e.target.classList.contains('toggle-details-btn')) {
                    const runId = e.target.dataset.runid;
                    const detailsDiv = document.getElementById(`${runId}-details`);
                    if (detailsDiv) {
                        const isCurrentlyExpanded = detailsDiv.classList.contains('expanded');
                        detailsDiv.classList.toggle('expanded');
                        e.target.textContent = isCurrentlyExpanded ? '+' : '‚àí';
                        expandedState[runId] = !isCurrentlyExpanded;
                        saveExpandedState();
                    }
                } else if (e.target.classList.contains('skip-btn')) {
                     if (!currentUser) { alert("Please sign in to modify run status."); return;}
                    const runId = e.target.dataset.runid;
                    updateRunDataAndUI(runId, 'status', 'skipped');
                } else if (e.target.classList.contains('reschedule-btn')) {
                    if (!currentUser) { alert("Please sign in to reschedule runs."); return;}
                    const runId = e.target.dataset.runid;
                    const container = document.getElementById(`${runId}-reschedule-input-container`);
                    if (container) container.style.display = 'flex'; // Show date input
                } else if (e.target.classList.contains('confirm-reschedule-btn')) {
                    if (!currentUser) return;
                    const runId = e.target.dataset.runid;
                    const dateInput = document.getElementById(`${runId}-reschedule-date`);
                    if (dateInput.value) {
                        updateRunDataAndUI(runId, 'rescheduledTo', dateInput.value);
                        document.getElementById(`${runId}-reschedule-input-container`).style.display = 'none';
                    } else {
                        alert("Please select a date.");
                    }
                } else if (e.target.classList.contains('cancel-reschedule-btn')) {
                    const runId = e.target.dataset.runid;
                    document.getElementById(`${runId}-reschedule-input-container`).style.display = 'none';
                } else if (e.target.classList.contains('undo-btn')) {
                    if (!currentUser) { alert("Please sign in to undo actions."); return; }
                    const runId = e.target.dataset.runid;
                    updateRunDataAndUI(runId, 'undo', true); 
                }
            });
        }
        
        function updateWeeklySummaryDisplay(weekNumber, plannedKm) {
            let totalActualDistance = 0;
            let totalActualSeconds = 0;

            for (const runId in runLogData) {
                if (runId.startsWith(`w${weekNumber}d`)) {
                    const log = runLogData[runId];
                    if (log.status !== 'skipped' && log.status !== 'rescheduled' && log.actualDistance && isValidDistance(log.actualDistance)) {
                        totalActualDistance += parseFloat(log.actualDistance) || 0;
                    }
                    if (log.status !== 'skipped' && log.status !== 'rescheduled' && log.actualTime && parseTimeToSeconds(log.actualTime) !== -1) {
                        totalActualSeconds += parseTimeToSeconds(log.actualTime);
                    }
                }
            }
            const summaryVisualsEl = document.getElementById(`week-${weekNumber}-summary-visuals`);
            if (summaryVisualsEl) {
                const percentage = plannedKm > 0 ? Math.min(100, (totalActualDistance / plannedKm) * 100) : 0;
                summaryVisualsEl.innerHTML = `
                    <div class="weekly-summary-details">
                        <span>Distance: ${totalActualDistance.toFixed(2)}km / ${plannedKm}km planned</span>
                        <span>Time: ${formatSecondsToHHMMSS(totalActualSeconds)}</span>
                    </div>
                    <div class="progress-bar-container mt-1">
                        <div class="progress-bar ${percentage === 100 ? 'full' : ''}" style="width: ${percentage.toFixed(1)}%;">${percentage.toFixed(0)}%</div>
                    </div>
                `;
            }
        }

        function toggleAllDetails(expand) {
            document.querySelectorAll('.run-details-collapsible').forEach(div => {
                const runId = div.id.replace('-details', '');
                const toggleButton = planContainer.querySelector(`.toggle-details-btn[data-runid="${runId}"]`);
                if (expand) {
                    div.classList.add('expanded');
                    if (toggleButton) toggleButton.textContent = '‚àí';
                    expandedState[runId] = true;
                } else {
                    div.classList.remove('expanded');
                     if (toggleButton) toggleButton.textContent = '+';
                    expandedState[runId] = false;
                }
            });
            saveExpandedState();
        }
        
        function setupSidebarToggles() {
            document.querySelectorAll('.sidebar-toggle-btn').forEach(button => {
                const targetId = button.dataset.target;
                const contentDiv = document.getElementById(targetId);
                if (contentDiv) {
                    if (sidebarExpandedState[targetId]) {
                        contentDiv.classList.add('expanded');
                        button.textContent = '‚àí';
                    } else {
                        contentDiv.classList.remove('expanded');
                        button.textContent = '+';
                    }
                    button.addEventListener('click', () => {
                        const isExpanded = contentDiv.classList.toggle('expanded');
                        button.textContent = isExpanded ? '‚àí' : '+';
                        sidebarExpandedState[targetId] = isExpanded;
                        saveSidebarExpandedState();
                    });
                }
            });
            document.querySelectorAll('.tip-category-header').forEach(header => {
                const targetId = header.dataset.target;
                const contentDiv = document.getElementById(targetId);
                const toggleBtn = header.querySelector('.tip-toggle-btn');
                if(contentDiv && toggleBtn){
                    if (sidebarExpandedState[targetId]) {
                        contentDiv.classList.add('expanded');
                        toggleBtn.textContent = '‚àí';
                    } else {
                        contentDiv.classList.remove('expanded');
                        toggleBtn.textContent = '+';
                    }
                    header.addEventListener('click', () => {
                        const isExpanded = contentDiv.classList.toggle('expanded');
                        toggleBtn.textContent = isExpanded ? '‚àí' : '+';
                        sidebarExpandedState[targetId] = isExpanded;
                        saveSidebarExpandedState();
                    });
                }
            });
        }


        function renderPlan(isFull) {
            planContainer.innerHTML = ''; 
            let dataToDisplay = isFull ? trainingPlanData : [trainingPlanData.find(w => w.week === currentWeekNumberGlobal)];
            if (!dataToDisplay[0] && trainingPlanData.length > 0) dataToDisplay = [trainingPlanData[0]]; 
            
            const table = createTable(dataToDisplay, isFull, currentWeekNumberGlobal);
            planContainer.appendChild(table);
            
            dataToDisplay.forEach(weekData => {
                updateWeeklySummaryDisplay(weekData.week, weekData.totalKm);
            });
        }


        viewWeekBtn.addEventListener('click', () => {
            renderPlan(false);
            planIntro.textContent = `Showing the plan for Week ${currentWeekNumberGlobal}. Log your runs!`;
            viewWeekBtn.classList.add('bg-teal-600', 'text-white');
            viewWeekBtn.classList.remove('bg-slate-200', 'text-slate-800');
            viewFullBtn.classList.add('bg-slate-200', 'text-slate-800');
            viewFullBtn.classList.remove('bg-teal-600', 'text-white');
        });

        viewFullBtn.addEventListener('click', () => {
            renderPlan(true);
            planIntro.textContent = `Showing the full 12-week plan. Current week (${currentWeekNumberGlobal}) is highlighted.`;
            viewFullBtn.classList.add('bg-teal-600', 'text-white');
            viewFullBtn.classList.remove('bg-slate-200', 'text-slate-800');
            viewWeekBtn.classList.add('bg-slate-200', 'text-slate-800');
            viewWeekBtn.classList.remove('bg-teal-600', 'text-white');
        });

        function startCountdown() {
            const interval = setInterval(() => {
                const now = new Date().getTime();
                const distance = raceDate - now;
                const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);
                document.getElementById("days").innerText = days < 10 ? '0' + days : days;
                document.getElementById("hours").innerText = hours < 10 ? '0' + hours : hours;
                document.getElementById("minutes").innerText = minutes < 10 ? '0' + minutes : minutes;
                document.getElementById("seconds").innerText = seconds < 10 ? '0' + seconds : seconds;
                if (distance < 0) {
                    clearInterval(interval);
                    document.getElementById("countdown").innerHTML = "<p class='text-lg font-bold text-teal-600'>Race Day has arrived! Good luck!</p>";
                }
            }, 1000);
        }

        function renderChart() {
            const today = new Date();
            const actualKms = trainingPlanData.map(weekData => {
                let weeklyActual = 0;
                for (let i = 0; i < 7; i++) { 
                    const runId = `w${weekData.week}d${i}`;
                    if (runLogData[runId] && runLogData[runId].status !== 'skipped' && runLogData[runId].status !== 'rescheduled' && runLogData[runId].actualDistance && isValidDistance(runLogData[runId].actualDistance)) {
                        weeklyActual += parseFloat(runLogData[runId].actualDistance);
                    }
                }
                return weeklyActual;
            });

            const actualKmColors = trainingPlanData.map((weekData, index) => {
                const weekStartDateForCalc = new Date(planStartDate);
                weekStartDateForCalc.setDate(weekStartDateForCalc.getDate() + (weekData.week - 1) * 7);
                const weekEndDateForCalc = new Date(weekStartDateForCalc);
                weekEndDateForCalc.setDate(weekEndDateForCalc.getDate() + 6);

                if (weekEndDateForCalc < today || weekData.week === currentWeekNumberGlobal) { 
                    const planned = weekData.totalKm;
                    const actual = actualKms[index];
                    if (planned === 0 && actual > 0) return 'rgba(16, 185, 129, 0.7)'; 
                    if (planned === 0) return 'rgba(203, 213, 225, 0.5)'; 
                    const percentage = (actual / planned);
                    if (percentage >= 0.95) return 'rgba(16, 185, 129, 0.7)'; 
                    if (percentage >= 0.70) return 'rgba(245, 158, 11, 0.7)'; 
                    return 'rgba(239, 68, 68, 0.7)'; 
                }
                return 'rgba(100, 116, 139, 0.5)'; 
            });

            const ctx = document.getElementById('mileageChart').getContext('2d');
            if (mileageChartInstance) {
                mileageChartInstance.destroy();
            }
            mileageChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: trainingPlanData.map(w => `Wk ${w.week}`),
                    datasets: [
                        {
                            label: 'Planned KM',
                            data: trainingPlanData.map(w => w.totalKm),
                            backgroundColor: trainingPlanData.map(w => w.week === currentWeekNumberGlobal ? 'rgba(20, 184, 166, 0.7)' : 'rgba(20, 184, 166, 0.3)'), 
                            borderColor: trainingPlanData.map(w => w.week === currentWeekNumberGlobal ? 'rgba(15, 118, 110, 1)' : 'rgba(15, 118, 110, 0.5)'), 
                            borderWidth: 1,
                            order: 2
                        },
                        {
                            label: 'Actual KM',
                            data: actualKms,
                            backgroundColor: actualKmColors,
                            borderColor: actualKmColors.map(color => color.replace(/0\.[753]\)/, '1)')), 
                            borderWidth: 1,
                            order: 1
                        }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { 
                        y: { beginAtZero: true, title: { display: true, text: 'Kilometers' } }, 
                        x: { grid: { display: false } } 
                    },
                    plugins: { 
                        legend: { display: true, position: 'top'}, 
                        tooltip: { 
                            mode: 'index',
                            intersect: false,
                            callbacks: { 
                                title: (ctx) => ctx[0].label,
                            }
                        }
                    }
                }
            });
        }

        // Auth UI and Logic
        googleSigninBtn.addEventListener('click', async () => {
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Error during sign in:", error);
                alert("Sign in failed. Please try again. Error: " + error.message);
            }
        });

        signoutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Error during sign out:", error);
            }
        });
        
        resetDataBtn.addEventListener('click', async () => {
            if (!currentUser) {
                alert("Please sign in to reset data.");
                return;
            }
            if (confirm("‚ö†Ô∏è Are you sure you want to reset ALL training log data? This cannot be undone.")) {
                if (confirm("‚ö†Ô∏è FINAL CONFIRMATION: Reset all data? This will clear everything Am√©lie has logged.")) {
                    try {
                        const docRef = doc(db, "runLogs", SHARED_RUN_LOG_DOC_ID);
                        await deleteDoc(docRef); // Deletes the entire document
                        runLogData = {}; // Clear local data
                        expandedState = {}; // Clear local expanded state
                        saveExpandedState();
                        alert("All training data has been reset.");
                        // The onSnapshot listener should automatically update the UI to an empty state
                        // or you can explicitly call renderPlan and renderChart.
                         renderPlan(viewFullBtn.classList.contains('bg-teal-600'));
                         renderChart();
                    } catch (error) {
                        console.error("Error resetting data:", error);
                        alert("Failed to reset data. Check console for errors. Error: " + error.message);
                    }
                }
            }
        });
        
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                userNameSpan.textContent = user.displayName || user.email;
                userInfoDiv.classList.remove('hidden');
                googleSigninBtn.classList.add('hidden');
                resetDataBtn.classList.remove('hidden'); // Show reset button when logged in
                planIntro.textContent = `Log your runs, ${user.displayName || 'runner'}! Progress is synced to the shared plan.`;
                loadRunLogDataFromFirestore(); 
            } else {
                currentUser = null;
                if (unsubscribeFromFirestore) {
                    unsubscribeFromFirestore(); 
                    unsubscribeFromFirestore = null;
                }
                loadRunLogDataFromFirestore(); 
                
                userNameSpan.textContent = '';
                userInfoDiv.classList.add('hidden');
                googleSigninBtn.classList.remove('hidden');
                resetDataBtn.classList.add('hidden'); // Hide reset button when not logged in
                planIntro.textContent = 'Please sign in to save and sync your progress with the shared plan. Viewing read-only.';
                renderPlan(viewFullBtn.classList.contains('bg-teal-600')); 
                renderChart(); 
            }
        });
            
        attachInputListeners(); 
        startCountdown();
        setupSidebarToggles(); 
    </script>
</body>
</html>
